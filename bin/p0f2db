#! /usr/bin/env python

# This file is part of IVRE.
# Copyright 2011 - 2014 Pierre LALET <pierre.lalet@cea.fr>
#
# IVRE is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# IVRE is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
# or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public
# License for more details.
#
# You should have received a copy of the GNU General Public License
# along with IVRE. If not, see <http://www.gnu.org/licenses/>.

import ivre.db
import ivre.utils
import ivre.passive

import re
import subprocess
import datetime
import signal


def terminate(signum, stack_frame):
    p0fprocess.stdout.close()
    p0fprocess.terminate()
    exit()

signal.signal(signal.SIGINT, terminate)
signal.signal(signal.SIGTERM, terminate)


def process_file(sensor, fname, mode='SYN'):
    global p0fprocess
    distre = re.compile('distance ([0-9]+),')
    if fname.startswith('iface:'):
        fname = ['-i', fname[6:]]
    else:
        fname = ['-s', fname]
    mode = ivre.passive.P0F_MODES[mode]
    p0fprocess = subprocess.Popen(
        ['p0f', '-l', '-S', '-ttt'] + fname
        + mode['options'] + [mode['filter']],
        stdout=subprocess.PIPE
    )
    for line in p0fprocess.stdout:
        timestamp, spec = ivre.passive.parse_p0f_line(
            line,
            include_port=(mode['name'] == 'SYN+ACK')
        )
        spec['sensor'] = sensor
        spec['recontype'] = 'P0F2-%s' % mode['name']
        ivre.db.db.passive.insert_or_update(timestamp, spec)

if __name__ == '__main__':
    import sys
    if len(sys.argv) == 4:
        process_file(sys.argv[1], sys.argv[2], mode=sys.argv[3])
    else:
        process_file(sys.argv[1], sys.argv[2])
